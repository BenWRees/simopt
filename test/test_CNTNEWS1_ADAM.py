import unittest
import math

from simopt.experiment_base import ProblemSolver, post_normalize

# Note: Tests have inherent randomness and may vary **slightly** between
#       runs/systems. To make sure these tsts still work, assertAlmostEqual
#       is used instead of assertEqual.
#       Some attributes, such as the lengths of lists, are still checked
#       with assertEqual as these should not change between runs.

class test_CNTNEWS1_ADAM(unittest.TestCase):
    def setUp(self):
        # Expected values
        self.expected_problem_name = "CNTNEWS-1"
        self.expected_solver_name = "ADAM"
        self.expected_all_recommended_xs = "[[(0,), (0.3050233636669336,), (0.2185317126338197,), (0.2115705602775329,), (0.2034744970188075,), (0.20535476709242967,), (0.20535476709242967,)], [(0,), (0.2725771987747624,), (0.2034732984953683,), (0.1795409828609915,), (0.16317885111803027,), (0.16317885111803027,)], [(0,), (0.2806815845546738,), (0.27640546292420576,), (0.2588670862825194,), (0.21583603286051675,), (0.22102581271128185,), (0.22102581271128185,)], [(0,), (0.3050233636669336,), (0.05516878405414677,), (0.0632553264439476,), (0.20685036996348966,), (0.158589812817196,), (0.1643735906708466,), (0.1643735906708466,)], [(0,), (0.3050233636669336,), (0.04805048595026229,), (0.06867616073995278,), (0.2248357885029174,), (0.22158598672334645,), (0.10862099391658879,), (0.1777928651002421,), (0.12582058057141132,), (0.16886924231685357,), (0.15915350778089685,), (0.14217170001851342,), (0.1446770220893471,), (0.1446770220893471,)], [(0,), (0.3050233636669336,), (0.04805048595026229,), (0.16569355019956494,), (0.13887261336221146,), (0.1434989459659648,), (0.1434989459659648,)], [(0,), (0.2725771987747624,), (0.22306227804941628,), (0.15230777951704738,), (0.20387067040674817,), (0.18093045387729906,), (0.18093045387729906,)], [(0,), (0.3050233636669336,), (0.22468852268986378,), (0.22900671490707683,), (0.22900671490707683,)], [(0,), (0.2725771987747624,), (0.21759199014126873,), (0.26097962117772194,), (0.22192926958495923,), (0.22192926958495923,)], [(0,), (0.2725771987747624,), (0.088601251460549,), (0.24293162791944506,), (0.20857393715254818,), (0.1838878244881581,), (0.1675013793965652,), (0.16547008519472642,), (0.16547008519472642,)], [(0,), (0.2725771987747624,), (0.06333791122900481,), (0.20885830928445737,), (0.10474597012315198,), (0.17638484904472046,), (0.17078064614009814,), (0.14552487982771428,), (0.1456491122405623,), (0.14647513560426031,), (0.14647513560426031,)], [(0,), (0.2725771987747624,), (0.2160177899064246,), (0.18536592372712205,), (0.1919107376491353,), (0.1919107376491353,)], [(0,), (0.3050233636669336,), (0.23705347107883595,), (0.22753415406032557,), (0.22753415406032557,)], [(0,), (0.2725771987747624,), (0.21405037911071403,), (0.14174945638768338,), (0.15655997953059034,), (0.17091789266538568,), (0.1679814258252685,), (0.1679814258252685,)], [(0,), (0.2725771987747624,), (0.07657076904809726,), (0.21142224095284826,), (0.17263652794470039,), (0.13468527175965833,), (0.1403288952518379,), (0.1574582131302707,), (0.1574582131302707,)], [(0,), (0.34034156401920135,), (0.1077538175166583,), (0.23143909531000098,), (0.20893809748263753,), (0.20893809748263753,)], [(0,), (0.3050233636669336,), (0.24019744809038177,), (0.19777492487909942,), (0.18309346147573785,), (0.18227817276505695,), (0.18227817276505695,)], [(0,), (0.4909308225567295,), (0.3050233636669336,), (0.2774574455261522,), (0.2101631600983737,), (0.21174184553499248,), (0.22725319785748133,), (0.255972449212661,), (0.24005571097903772,), (0.24005571097903772,)], [(0,), (0.2893577948799854,), (0.14619516666384097,), (0.18326754092656905,), (0.19039832196573941,), (0.21311067318862426,), (0.21311067318862426,)], [(0,), (0.2725771987747624,), (0.23130816703067109,), (0.15128888604571786,), (0.17799750673679376,), (0.18492638613980344,), (0.18492638613980344,)], [(0,), (0.2806815845546738,), (0.233861809148043,), (0.17710128622761778,), (0.17710128622761778,)], [(0,), (0.2806815845546738,), (0.23899126182687752,), (0.19250706452301625,), (0.19250706452301625,)], [(0,), (0.3050233636669336,), (0.2041591736927062,), (0.17516540335241215,), (0.17516540335241215,)], [(0,), (0.2725771987747624,), (0.18925428695012203,), (0.18925428695012203,)]]"
        self.expected_all_intermediate_budgets = "[[0, 120, 240, 360, 480, 990, 1000], [0, 120, 240, 360, 870, 1000], [0, 120, 240, 570, 690, 810, 1000], [0, 120, 150, 210, 240, 360, 690, 1000], [0, 120, 150, 210, 240, 330, 360, 450, 570, 660, 750, 840, 960, 1000], [0, 120, 150, 240, 360, 450, 1000], [0, 120, 240, 450, 570, 810, 1000], [0, 120, 240, 480, 1000], [0, 120, 240, 510, 630, 1000], [0, 120, 210, 240, 360, 480, 630, 990, 1000], [0, 120, 210, 240, 360, 450, 660, 750, 840, 930, 1000], [0, 120, 240, 360, 810, 1000], [0, 120, 240, 360, 1000], [0, 120, 240, 360, 450, 900, 990, 1000], [0, 120, 210, 240, 360, 660, 810, 900, 1000], [0, 120, 150, 240, 360, 1000], [0, 120, 240, 480, 720, 870, 1000], [0, 90, 120, 240, 360, 450, 600, 810, 900, 1000], [0, 120, 210, 360, 450, 600, 1000], [0, 120, 240, 360, 600, 930, 1000], [0, 120, 240, 360, 1000], [0, 120, 240, 360, 1000], [0, 120, 240, 360, 1000], [0, 120, 240, 1000]]"
        self.expected_all_est_objectives = "[[0.0, 0.2866944995117209, 0.4270040211263273, 0.432962800065976, 0.4389898785373815, 0.43770004290136166, 0.43770004290136166], [0.0, 0.41288144547221917, 0.5028310521215722, 0.5030272191109962, 0.4919194521060183, 0.4919194521060183], [0.0, 0.3084932225679554, 0.3194851879256968, 0.3599298190036173, 0.42641588145254405, 0.4203351568187604, 0.4203351568187604], [0.0, 0.33367362050453614, 0.21375997803437585, 0.24361252286227952, 0.4976984022484743, 0.48009844774773397, 0.48615874613394794, 0.48615874613394794], [0.0, 0.20452682706858255, 0.1863253400472016, 0.25396435174168486, 0.37485167137452247, 0.37979137007947017, 0.35366879069931345, 0.4127187348063703, 0.38441236963740516, 0.4142319251871544, 0.4131756712983314, 0.40418969723550285, 0.4062792513744203, 0.4062792513744203], [0.0, 0.31589897626071384, 0.18979268131943974, 0.4727909006761207, 0.44132901687544773, 0.448336501970893, 0.448336501970893], [0.0, 0.37611932004794185, 0.45736623665394505, 0.45779123160934304, 0.4730057444140837, 0.47505162977475124, 0.47505162977475124], [0.0, 0.26516847939808513, 0.41836710672983884, 0.41344178356794214, 0.41344178356794214], [0.0, 0.3259754261383471, 0.42296778632489923, 0.3511455433674098, 0.417807809989936, 0.417807809989936], [0.0, 0.32811930952150914, 0.3056856268769611, 0.3819612974960285, 0.42230304506457644, 0.43107548310011623, 0.4268483052570336, 0.42595453580822457, 0.42595453580822457], [0.0, 0.42195023515778857, 0.24130662588981744, 0.4917234524223932, 0.36812734342431086, 0.48747175555722566, 0.48432936563047974, 0.45784758840188494, 0.458036421669414, 0.45928160075035296, 0.45928160075035296], [0.0, 0.31899906068325007, 0.41529159798709087, 0.4353118919478432, 0.4332052910212116, 0.4332052910212116], [0.0, 0.29750419336494693, 0.4453569445246158, 0.45670168421522106, 0.45670168421522106], [0.0, 0.39260083714680205, 0.4755456264567722, 0.4367850973176371, 0.4559202843009929, 0.4681186855910971, 0.46599324491313593, 0.46599324491313593], [0.0, 0.35265181515190575, 0.27756488068111496, 0.4341480279044428, 0.4393573773141198, 0.40718133342405566, 0.41440552058861796, 0.4310009704344759, 0.4310009704344759], [0.0, 0.1896312951891995, 0.36293754821934643, 0.4370202970585069, 0.4508852594549166, 0.4508852594549166], [0.0, 0.2381388803731723, 0.38529150589258565, 0.429499334141851, 0.43511772891702494, 0.4353460097560155, 0.4353460097560155], [0.0, -0.4014591894495358, 0.23350088082741355, 0.3045934346675987, 0.414992559501964, 0.4136213103728916, 0.3968047561080678, 0.3500071677483887, 0.3780519219939509, 0.3780519219939509], [0.0, 0.3752820470891163, 0.4546775002522965, 0.48701011995443566, 0.4887516132774112, 0.4830675117552003, 0.4830675117552003], [0.0, 0.41133635771663263, 0.4748791078035478, 0.46566162219391183, 0.4941879225903984, 0.4961596231973673, 0.4961596231973673], [0.0, 0.32103961022274236, 0.4165819035141714, 0.4488492517460236, 0.4488492517460236], [0.0, 0.36639226758830135, 0.43540292530682395, 0.47440486714722363, 0.47440486714722363], [0.0, 0.28571806052314835, 0.46178119460510103, 0.46159844959729684, 0.46159844959729684], [0.0, 0.35664672514722523, 0.4693278043043396, 0.4693278043043396]]"
        self.expected_objective_curves = "[([0, 120, 240, 360, 480, 990, 1000], [0.0, 0.2866944995117209, 0.4270040211263273, 0.432962800065976, 0.4389898785373815, 0.43770004290136166, 0.43770004290136166]), ([0, 120, 240, 360, 870, 1000], [0.0, 0.41288144547221917, 0.5028310521215722, 0.5078709170979363, 0.4919194521060183, 0.4919194521060183]), ([0, 120, 240, 570, 690, 810, 1000], [0.0, 0.3084932225679554, 0.3194851879256968, 0.3599298190036173, 0.42641588145254405, 0.4203351568187604, 0.4203351568187604]), ([0, 120, 150, 210, 240, 360, 690, 1000], [0.0, 0.33367362050453614, 0.21375997803437585, 0.24361252286227952, 0.4976984022484743, 0.48009844774773397, 0.48615874613394794, 0.48615874613394794]), ([0, 120, 150, 210, 240, 330, 360, 450, 570, 660, 750, 840, 960, 1000], [0.0, 0.20452682706858255, 0.1863253400472016, 0.25396435174168486, 0.37485167137452247, 0.37979137007947017, 0.35366879069931345, 0.4127187348063703, 0.38441236963740516, 0.4142319251871544, 0.4131756712983314, 0.40418969723550285, 0.4062792513744203, 0.4062792513744203]), ([0, 120, 150, 240, 360, 450, 1000], [0.0, 0.31589897626071384, 0.18979268131943974, 0.4727909006761207, 0.44132901687544773, 0.448336501970893, 0.448336501970893]), ([0, 120, 240, 450, 570, 810, 1000], [0.0, 0.37611932004794185, 0.45736623665394505, 0.45779123160934304, 0.4730057444140837, 0.47505162977475124, 0.47505162977475124]), ([0, 120, 240, 480, 1000], [0.0, 0.26516847939808513, 0.41836710672983884, 0.41344178356794214, 0.41344178356794214]), ([0, 120, 240, 510, 630, 1000], [0.0, 0.3259754261383471, 0.42296778632489923, 0.3511455433674098, 0.417807809989936, 0.417807809989936]), ([0, 120, 210, 240, 360, 480, 630, 990, 1000], [0.0, 0.32811930952150914, 0.3056856268769611, 0.3819612974960285, 0.42230304506457644, 0.43107548310011623, 0.4268483052570336, 0.42595453580822457, 0.42595453580822457]), ([0, 120, 210, 240, 360, 450, 660, 750, 840, 930, 1000], [0.0, 0.42195023515778857, 0.24130662588981744, 0.4917234524223932, 0.36812734342431086, 0.48747175555722566, 0.48432936563047974, 0.45784758840188494, 0.458036421669414, 0.45928160075035296, 0.45928160075035296]), ([0, 120, 240, 360, 810, 1000], [0.0, 0.31899906068325007, 0.41529159798709087, 0.4353118919478432, 0.4332052910212116, 0.4332052910212116]), ([0, 120, 240, 360, 1000], [0.0, 0.29750419336494693, 0.4453569445246158, 0.45670168421522106, 0.45670168421522106]), ([0, 120, 240, 360, 450, 900, 990, 1000], [0.0, 0.39260083714680205, 0.4755456264567722, 0.4367850973176371, 0.4559202843009929, 0.4681186855910971, 0.46599324491313593, 0.46599324491313593]), ([0, 120, 210, 240, 360, 660, 810, 900, 1000], [0.0, 0.35265181515190575, 0.27756488068111496, 0.4341480279044428, 0.4393573773141198, 0.40718133342405566, 0.41440552058861796, 0.4310009704344759, 0.4310009704344759]), ([0, 120, 150, 240, 360, 1000], [0.0, 0.1896312951891995, 0.36293754821934643, 0.4370202970585069, 0.4508852594549166, 0.4508852594549166]), ([0, 120, 240, 480, 720, 870, 1000], [0.0, 0.2381388803731723, 0.38529150589258565, 0.429499334141851, 0.43511772891702494, 0.4353460097560155, 0.4353460097560155]), ([0, 90, 120, 240, 360, 450, 600, 810, 900, 1000], [0.0, -0.4014591894495358, 0.23350088082741355, 0.3045934346675987, 0.414992559501964, 0.4136213103728916, 0.3968047561080678, 0.3500071677483887, 0.3780519219939509, 0.3780519219939509]), ([0, 120, 210, 360, 450, 600, 1000], [0.0, 0.3752820470891163, 0.4546775002522965, 0.48701011995443566, 0.4887516132774112, 0.4830675117552003, 0.4830675117552003]), ([0, 120, 240, 360, 600, 930, 1000], [0.0, 0.41133635771663263, 0.4748791078035478, 0.46566162219391183, 0.4941879225903984, 0.4961596231973673, 0.4961596231973673]), ([0, 120, 240, 360, 1000], [0.0, 0.32103961022274236, 0.4165819035141714, 0.4488492517460236, 0.4488492517460236]), ([0, 120, 240, 360, 1000], [0.0, 0.36639226758830135, 0.43540292530682395, 0.47440486714722363, 0.47440486714722363]), ([0, 120, 240, 360, 1000], [0.0, 0.28571806052314835, 0.46178119460510103, 0.46159844959729684, 0.46159844959729684]), ([0, 120, 240, 1000], [0.0, 0.35664672514722523, 0.4693278043043396, 0.4693278043043396])]"
        self.expected_progress_curves = "[([0.0, 0.12, 0.24, 0.36, 0.48, 0.99, 1.0], [1.0, 0.4354973087454118, 0.15922726277317997, 0.14749440164835284, 0.13562705845444586, 0.13816675031825676, 0.13816675031825676]), ([0.0, 0.12, 0.24, 0.36, 0.87, 1.0], [1.0, 0.18703467441786917, 0.00992351561527244, -0.0, 0.03140850254444081, 0.03140850254444081]), ([0.0, 0.12, 0.24, 0.57, 0.69, 0.81, 1.0], [1.0, 0.3925755301549064, 0.3709323035245032, 0.2912966525818813, 0.16038531229714953, 0.17235828501338615, 0.17235828501338615]), ([0.0, 0.12, 0.15, 0.21, 0.24, 0.36, 0.69, 1.0], [1.0, 0.34299521931437643, 0.5791056923364741, 0.5203259043571066, 0.02002972508760604, 0.05468411049976853, 0.04275135715204077, 0.04275135715204077]), ([0.0, 0.12, 0.15, 0.21, 0.24, 0.33, 0.36, 0.45, 0.57, 0.66, 0.75, 0.84, 0.96, 1.0], [1.0, 0.597285805934144, 0.6331246114428104, 0.49994310918041573, 0.26191546167579194, 0.25218917387578554, 0.3036246439937158, 0.1873550524122986, 0.2430904060543474, 0.18437557410424593, 0.1864553425124443, 0.20414876373486035, 0.20003442273093458, 0.20003442273093458]), ([0.0, 0.12, 0.15, 0.24, 0.36, 0.45, 1.0], [1.0, 0.37799356957508784, 0.626297401702093, 0.06907270182405602, 0.13102128509882133, 0.11722351708428874, 0.11722351708428874]), ([0.0, 0.12, 0.24, 0.45, 0.57, 0.81, 1.0], [1.0, 0.2594194560358885, 0.09944393101417164, 0.09860711413592531, 0.06864967358847462, 0.06462131659501245, 0.06462131659501245]), ([0.0, 0.12, 0.24, 0.48, 1.0], [1.0, 0.47788213407984764, 0.17623338402509434, 0.18593136631957355, 0.18593136631957355]), ([0.0, 0.12, 0.24, 0.51, 0.63, 1.0], [1.0, 0.3581529968263826, 0.1671746262971475, 0.3085929287427657, 0.17733464168934251, 0.17733464168934251]), ([0.0, 0.12, 0.21, 0.24, 0.36, 0.48, 0.63, 0.99, 1.0], [1.0, 0.3539316813090213, 0.39810369803472406, 0.24791657754568333, 0.16848350467144235, 0.15121053679671734, 0.15953386798338473, 0.1612937038367866, 0.1612937038367866]), ([0.0, 0.12, 0.21, 0.24, 0.36, 0.45, 0.66, 0.75, 0.84, 0.93, 1.0], [1.0, 0.169178188881367, 0.5248662253222021, 0.031794426756729, 0.2751556920647175, 0.04016603600236658, 0.04635341515906666, 0.09849614737125223, 0.09812433386279604, 0.09567257094623816, 0.09567257094623816]), ([0.0, 0.12, 0.24, 0.36, 0.81, 1.0], [1.0, 0.3718894901364568, 0.1822890738454959, 0.14286902972256835, 0.1470169359241463, 0.1470169359241463]), ([0.0, 0.12, 0.24, 0.36, 1.0], [1.0, 0.41421297548412855, 0.1230902783930537, 0.10075243759793381, 0.10075243759793381]), ([0.0, 0.12, 0.24, 0.36, 0.45, 0.9, 0.99, 1.0], [1.0, 0.22696727863412175, 0.06364863502300254, 0.139968282071547, 0.10229101735889592, 0.07827231323658075, 0.08245731498881007, 0.08245731498881007]), ([0.0, 0.12, 0.21, 0.24, 0.36, 0.66, 0.81, 0.9, 1.0], [1.0, 0.3056270731802872, 0.4534735671277074, 0.14516068298369803, 0.13490345179699387, 0.19825821933108245, 0.18403376401900712, 0.15135725255289043, 0.15135725255289043]), ([0.0, 0.12, 0.15, 0.24, 0.36, 1.0], [1.0, 0.6266151716802646, 0.2853744209390146, 0.13950517277949734, 0.11220500273700605, 0.11220500273700605]), ([0.0, 0.12, 0.24, 0.48, 0.72, 0.87, 1.0], [1.0, 0.5311035297434636, 0.24135938302155782, 0.15431398081212117, 0.14325133755765318, 0.14280185161288791, 0.14280185161288791]), ([0.0, 0.09, 0.12, 0.24, 0.36, 0.45, 0.6, 0.81, 0.9, 1.0], [1.0, 1.790474854798822, 0.5402357706133704, 0.40025422914921155, 0.1828778818970292, 0.18557787727559494, 0.21868974428486682, 0.31083439518767647, 0.2556141545686333, 0.2556141545686333]), ([0.0, 0.12, 0.21, 0.36, 0.45, 0.6, 1.0], [1.0, 0.2610680500597595, 0.1047380644467621, 0.04107499847146772, 0.03764599069735315, 0.04883801081673868, 0.04883801081673868]), ([0.0, 0.12, 0.24, 0.36, 0.6, 0.93, 1.0], [1.0, 0.19007695879283484, 0.06496101309149477, 0.08311028153613483, 0.02694187449386734, 0.02305958759656767, 0.02305958759656767]), ([0.0, 0.12, 0.24, 0.36, 1.0], [1.0, 0.3678716393976266, 0.17974845676418405, 0.11621391059203172, 0.11621391059203172]), ([0.0, 0.12, 0.24, 0.36, 1.0], [1.0, 0.27857206377964866, 0.14268978465080692, 0.06589479496471971, 0.06589479496471971]), ([0.0, 0.12, 0.24, 0.36, 1.0], [1.0, 0.4374199212748949, 0.0907508599945042, 0.09111068569361773, 0.09111068569361773]), ([0.0, 0.12, 0.24, 1.0], [1.0, 0.29776107837564847, 0.07589155333768431, 0.07589155333768431])]"

        # Convert the expected values from string to their actual types
        self.expected_all_recommended_xs = eval(self.expected_all_recommended_xs, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_all_intermediate_budgets = eval(self.expected_all_intermediate_budgets, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_all_est_objectives = eval(self.expected_all_est_objectives, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_objective_curves = eval(self.expected_objective_curves, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_progress_curves = eval(self.expected_progress_curves, {'nan': float('nan'), 'inf': float('inf')})
        
        # Number of macro-replications and post-replications
        self.num_macroreps = 24
        self.num_postreps = 200

        # Setup the solver and experiment
        self.myexperiment = ProblemSolver(self.expected_solver_name, self.expected_problem_name)
        self.assertEqual(self.myexperiment.solver.name, self.expected_solver_name, "Solver name does not match (expected: " + self.expected_solver_name + ", actual: " + self.myexperiment.solver.name + ")")
        self.assertEqual(self.myexperiment.problem.name, self.expected_problem_name, "Problem name does not match (expected: " + self.expected_problem_name + ", actual: " + self.myexperiment.problem.name + ")")

    def test_run(self):
        # Check actual run results against expected
        self.myexperiment.run(n_macroreps=self.num_macroreps)
        self.assertEqual(self.myexperiment.n_macroreps, self.num_macroreps, "Number of macro-replications for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
        # For each macroreplication
        for mrep in range(self.num_macroreps):
            # Check to make sure the list lengths are the same
            self.assertEqual(len(self.myexperiment.all_recommended_xs[mrep]), len(self.expected_all_recommended_xs[mrep]), "Length of recommended solutions for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
            # For each list of recommended solutions
            for list in range(len(self.myexperiment.all_recommended_xs[mrep])):
                # Check to make sure the tuples are the same length
                self.assertEqual(len(self.myexperiment.all_recommended_xs[mrep][list]), len(self.expected_all_recommended_xs[mrep][list]), "Recommended solutions for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + ".")
                # For each tuple of recommended solutions
                for tuple in range(len(self.myexperiment.all_recommended_xs[mrep][list])):
                    self.assertAlmostEqual(self.myexperiment.all_recommended_xs[mrep][list][tuple], self.expected_all_recommended_xs[mrep][list][tuple], 5, "Recommended solutions for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + " and tuple " + str(tuple) + ".")
            # Check to make sure the list lengths are the same
            self.assertEqual(len(self.myexperiment.all_intermediate_budgets[mrep]), len(self.expected_all_intermediate_budgets[mrep]), "Length of intermediate budgets for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
            # For each list of intermediate budgets
            for list in range(len(self.myexperiment.all_intermediate_budgets[mrep])):
                # Check the values in the list
                self.assertAlmostEqual(self.myexperiment.all_intermediate_budgets[mrep][list], self.expected_all_intermediate_budgets[mrep][list], 5, "Intermediate budgets for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + ".")
            
    def test_post_replicate(self):
        # Simulate results from the run method
        self.myexperiment = ProblemSolver(self.expected_solver_name, self.expected_problem_name)
        self.myexperiment.n_macroreps = self.num_macroreps
        self.myexperiment.all_recommended_xs = self.expected_all_recommended_xs
        self.myexperiment.all_intermediate_budgets = self.expected_all_intermediate_budgets

        # Check actual post-replication results against expected
        self.myexperiment.post_replicate(n_postreps=self.num_postreps)
        self.assertEqual(self.myexperiment.n_postreps, self.num_postreps, "Number of post-replications for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
        # For each macroreplication
        for mrep in range(self.num_macroreps):
            # Check to make sure the list lengths are the same
            self.assertEqual(len(self.myexperiment.all_est_objectives[mrep]), len(self.expected_all_est_objectives[mrep]), "Estimated objectives for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
            # For each list in the estimated objectives
            for list in range(len(self.myexperiment.all_est_objectives[mrep])):
                # Check the values in the list
                self.assertAlmostEqual(self.myexperiment.all_est_objectives[mrep][list], self.expected_all_est_objectives[mrep][list], 5, "Estimated objectives for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + ".")

    def test_post_normalize(self):
        # Simulate results from the post_replicate method
        self.myexperiment = ProblemSolver(self.expected_solver_name, self.expected_problem_name)
        self.myexperiment.n_macroreps = self.num_macroreps
        self.myexperiment.n_postreps = self.num_postreps
        self.myexperiment.all_recommended_xs = self.expected_all_recommended_xs
        self.myexperiment.all_intermediate_budgets = self.expected_all_intermediate_budgets
        self.myexperiment.all_est_objectives = self.expected_all_est_objectives
        self.myexperiment.has_run = True
        self.myexperiment.has_postreplicated= True
        # Check actual post-normalization results against expected
        post_normalize([self.myexperiment], n_postreps_init_opt=self.num_postreps)

        # Loop through each curve object and convert it into a tuple
        for i in range(len(self.myexperiment.objective_curves)):
            self.myexperiment.objective_curves[i] = (self.myexperiment.objective_curves[i].x_vals, self.myexperiment.objective_curves[i].y_vals)
        for i in range(len(self.myexperiment.progress_curves)):
            self.myexperiment.progress_curves[i] = (self.myexperiment.progress_curves[i].x_vals, self.myexperiment.progress_curves[i].y_vals)

        for mrep in range(self.num_macroreps):
            # Check to make sure the same number of objective curves are present
            # This should probably always be 2 (x and y)
            self.assertEqual(len(self.myexperiment.objective_curves[mrep]), len(self.expected_objective_curves[mrep]), "Number of objective curves for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
            # Make sure that curves are only checked if they exist
            if (len(self.myexperiment.objective_curves[mrep]) > 0):
                # Make sure the lengths of the X and Y values are the same
                self.assertEqual(len(self.myexperiment.objective_curves[mrep][0]), len(self.expected_objective_curves[mrep][0]), "Length of X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                self.assertEqual(len(self.myexperiment.objective_curves[mrep][1]), len(self.expected_objective_curves[mrep][1]), "Length of Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                # Check X (0) and Y (1) values
                for x_index in range(len(self.myexperiment.objective_curves[mrep][0])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.objective_curves[mrep][0][x_index])):
                        self.assertTrue(math.isnan(self.expected_objective_curves[mrep][0][x_index]), "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.objective_curves[mrep][0][x_index], self.expected_objective_curves[mrep][0][x_index], 5, "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                for y_index in range(len(self.myexperiment.objective_curves[mrep][1])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.objective_curves[mrep][1][y_index])):
                        self.assertTrue(math.isnan(self.expected_objective_curves[mrep][1][y_index]), "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.objective_curves[mrep][1][y_index], self.expected_objective_curves[mrep][1][y_index], 5, "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")
            
            # Check to make sure the same number of progress curves are present
            # This should probably always be 2 (x and y)
            self.assertEqual(len(self.myexperiment.progress_curves[mrep]), len(self.expected_progress_curves[mrep]), "Number of progress curves for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
            # Make sure that curves are only checked if they exist
            if (len(self.myexperiment.progress_curves[mrep]) > 0):
                # Make sure the lengths of the X and Y values are the same
                self.assertEqual(len(self.myexperiment.progress_curves[mrep][0]), len(self.expected_progress_curves[mrep][0]), "Length of X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                self.assertEqual(len(self.myexperiment.progress_curves[mrep][1]), len(self.expected_progress_curves[mrep][1]), "Length of Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                # Check X (0) and Y (1) values
                for x_index in range(len(self.myexperiment.progress_curves[mrep][0])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.progress_curves[mrep][0][x_index])):
                        self.assertTrue(math.isnan(self.expected_progress_curves[mrep][0][x_index]), "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.progress_curves[mrep][0][x_index], self.expected_progress_curves[mrep][0][x_index], 5, "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                for y_index in range(len(self.myexperiment.progress_curves[mrep][1])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.progress_curves[mrep][1][y_index])):
                        self.assertTrue(math.isnan(self.expected_progress_curves[mrep][1][y_index]), "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.progress_curves[mrep][1][y_index], self.expected_progress_curves[mrep][1][y_index], 5, "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")      

import unittest
import math

from simopt.experiment_base import ProblemSolver, post_normalize

# Note: Tests have inherent randomness and may vary **slightly** between
#       runs/systems. To make sure these tsts still work, assertAlmostEqual
#       is used instead of assertEqual.
#       Some attributes, such as the lengths of lists, are still checked
#       with assertEqual as these should not change between runs.

class test_PARAMESTI1_SPSA(unittest.TestCase):
    def setUp(self):
        # Expected values
        self.expected_problem_name = "PARAMESTI-1"
        self.expected_solver_name = "SPSA"
        self.expected_all_recommended_xs = "[[(1, 1), (1.0730633963883887, 1.0730633963883887), (1.1805715652878455, 1.0490897761977567), (1.2524913870438796, 1.0361844323726817), (1.3285720514085386, 1.0487953467548081), (1.35137088137727, 1.0259965167860767), (1.3886982244185369, 1.0207014419585891), (1.420997980750457, 1.0162059758668371), (1.4372085985583554, 0.9999953580589386), (1.4372085985583554, 0.9999953580589386)], [(1, 1), (1.1193169611955687, 1.1193169611955687), (1.2136590735199597, 1.2136590735199597), (1.2915792151512941, 1.2915792151512941), (1.3163133639980131, 1.2668450663045752), (1.3380252596958442, 1.245133170606744), (1.3380252596958442, 1.245133170606744)], [(1, 1), (1.0745392310831705, 1.0745392310831705), (1.1373809936793897, 1.1373809936793897), (1.1911524060782865, 1.1911524060782865), (1.2382474132767798, 1.2382474132767798), (1.3008384843888667, 1.2445103621215379), (1.3494254815774904, 1.2506909348353838), (1.403264355534035, 1.2425407030788789), (1.403264355534035, 1.2425407030788789)], [(1, 1), (1.2937596768617543, 1.094638966275609), (1.3529983175239348, 1.0973875248786358), (1.3752074143280788, 1.0751784280744918), (1.3752074143280788, 1.0751784280744918)], [(1, 1), (1.0757440256108675, 1.0757440256108675), (1.1392822819785051, 1.1392822819785051), (1.2295567245212893, 1.1309320806415393), (1.3233583762926437, 1.1552821600558068), (1.347157472816242, 1.1314830635322084), (1.3692444110565622, 1.1093961252918882), (1.3898901791159632, 1.0887503572324873), (1.409303419094182, 1.0693371172542685), (1.4435233097041769, 1.0668667429837626), (1.4435233097041769, 1.0668667429837626)], [(1, 1), (1.0796222219458675, 1.0796222219458675), (1.147553802987517, 1.147553802987517), (1.2058742010337637, 1.2058742010337637), (1.257008861935299, 1.257008861935299), (1.3026370414566526, 1.3026370414566526), (1.343914574172541, 1.343914574172541), (1.3612590029340996, 1.3265701454109822), (1.3612590029340996, 1.3265701454109822)], [(1, 1), (1.124972388127519, 0.8750276118724808), (1.2171416936373776, 0.7828583063626222), (1.3206108928739768, 0.7367952268816601), (1.3745167329233416, 0.6828893868322954), (1.4724842473176216, 0.6842563637316473), (1.5053672227876733, 0.6513733882615957), (1.5590271782392189, 0.6431935427271658), (1.5590271782392189, 0.6431935427271658)], [(1, 1), (1.1, 1.1), (1.3981068340246214, 1.2156178806199394), (1.4546376721887448, 1.2128205093609161), (1.5014368713169837, 1.2105899293501292), (1.5223370586025773, 1.1896897420645356), (1.5223370586025773, 1.1896897420645356)], [(1, 1), (1.1, 1.1), (1.1985654273148325, 1.1985654273148325), (1.28622805223397, 1.28622805223397), (1.425766006028837, 1.1466900984391029), (1.5511660400211136, 1.0271143689670301), (1.6425912473413469, 0.9356891616467969), (1.7274391282551531, 0.8508412807329906), (1.785443054184837, 0.7502220737849563), (1.785443054184837, 0.7502220737849563)], [(1, 1), (1.1, 1.1), (1.1690717861244158, 1.0309282138755844), (1.2251016190343056, 0.9748983809656946), (1.304950299655502, 0.9592985531012898), (1.3403841081177335, 0.9238647446390583), (1.3726100598347155, 0.8916387929220764), (1.4022524779347332, 0.8619963748220588), (1.4753759802929316, 0.8801001198361371), (1.4952891759580946, 0.8601869241709741), (1.4952891759580946, 0.8601869241709741)], [(1, 1), (1.0837523547524426, 1.0837523547524426), (1.1524008167992552, 1.1524008167992552), (1.200784776896109, 1.1040168567024014), (1.310312145082606, 1.1311206911029106), (1.336938198345387, 1.1044946378401297), (1.3614296582128942, 1.0800031779726225), (1.40508857650801, 1.078203113320841), (1.424432703310378, 1.0588589865184728), (1.475269033418635, 1.0731356729476116), (1.475269033418635, 1.0731356729476116)], [(1, 1), (1.0534521340462182, 1.0534521340462182), (1.1015382198624744, 1.1015382198624744), (1.1439935338725002, 1.1439935338725002), (1.1819471752347612, 1.1819471752347612), (1.2430513502650848, 1.1760655601841083), (1.331077234387599, 1.2120538800443355), (1.3485239086736611, 1.1946072057582733), (1.3801932538132142, 1.1933030183212114), (1.3801932538132142, 1.1933030183212114)], [(1, 1), (1.1, 1.1), (1.1486997570581674, 1.0513002429418328), (1.188204153915755, 1.011795846084245), (1.2218526190534627, 0.9781473809465374), (1.282725921892608, 0.9799467314140471), (1.3304163243179148, 0.9828472212640316), (1.3696910035874441, 0.9861417470016263), (1.403102566648287, 0.9895656415593606), (1.4159232458426785, 0.9767449623649691), (1.4159232458426785, 0.9767449623649691)], [(1, 1), (1.1, 1.1), (1.1848722118461195, 1.1848722118461195), (1.2571379458305452, 1.2571379458305452), (1.3200086856893098, 1.3200086856893098), (1.3200086856893098, 1.3200086856893098)], [(1, 1), (1.1, 1.1), (1.2109104556452581, 0.989089544354742), (1.3008790904011343, 0.8991209095988658), (1.4216856329003356, 0.8666631721252019), (1.4734799482674856, 0.8148688567580518), (1.5460329443693426, 0.7921378553661635), (1.5935098223211444, 0.7643772708193631), (1.6349028682605091, 0.7391703680048866), (1.6349028682605091, 0.7391703680048866)], [(1, 1), (1.1375167433138489, 0.8624832566861511), (1.238937728518051, 0.761062271481949), (1.3365646593732432, 0.6941473199450443), (1.3899852699070145, 0.640726709411273), (1.4385696612119452, 0.5921423181063423), (1.4832590734236781, 0.5474529058946094), (1.5247334330296416, 0.5059785462886458), (1.5212541613290596, 0.5024992745880636), (1.518762145000175, 0.5000072582591791), (1.5536336285866987, 0.46513577467265543), (1.5822545956634126, 0.43032171024017524), (1.5822545956634126, 0.43032171024017524)], [(1, 1), (1.1, 1.1), (1.379317547930849, 0.820682452069151), (1.6058950901877669, 0.5941049098122332), (1.7988859250840352, 0.40111407491596485), (1.7124996555974576, 0.31472780542938733), (1.8831038868719683, 0.14412357415487667), (1.927227461026845, 0.1), (1.927227461026845, 0.1)], [(1, 1), (1.1798966939092321, 0.9798966939092323), (1.2462024192359233, 0.9813426140933676), (1.2784638076873265, 0.9673729759616156), (1.2989036056325827, 0.9469331780163596), (1.2989036056325827, 0.9469331780163596)], [(1, 1), (1.231102487459444, 0.7733257744360221), (1.3675338090588398, 0.6368944528366265), (1.4837412425017045, 0.5206870193937618), (1.5857493483742786, 0.41867891352118763), (1.5562555098693132, 0.38918507501622207), (1.6435218031612748, 0.30191878172426045), (1.6155629718007898, 0.27395995036377535), (1.693500965710652, 0.1960219564539132), (1.6667415887652062, 0.16926257950846746), (1.7360041682736738, 0.1), (1.7360041682736738, 0.1)], [(1, 1), (1.102123086223516, 0.897876913776484), (1.2186746486122446, 0.8637933786884735), (1.3476356351391803, 0.8953119301874998), (1.395694620501311, 0.8873157448719138), (1.419171967554697, 0.8638383978185278), (1.4850090658407473, 0.885523942034225), (1.4850090658407473, 0.885523942034225)], [(1, 1), (1.1, 1.1), (1.1539404065983674, 1.0460595934016328), (1.197695927316395, 1.0023040726836052), (1.3064385887194307, 1.0365078862327974), (1.3575151806380257, 1.0404498378967646), (1.3766569198379808, 1.0213080986968095), (1.4158088297282023, 1.0246745227513907), (1.467490176597433, 1.0457885037516161), (1.467490176597433, 1.0457885037516161)], [(1, 1), (1.1707724717013785, 0.9499521165560372), (1.306724981893935, 0.9636091028030571), (1.3713024117883492, 0.9539410451056914), (1.4012268410475819, 0.9240166158464587), (1.42899844238842, 0.8962450145056204), (1.4549579499345773, 0.8702855069594633), (1.4793677053992305, 0.8458757514948101), (1.517465920612532, 0.8378404828243692), (1.5378904493319916, 0.8174159541049095), (1.5378904493319916, 0.8174159541049095)], [(1, 1), (1.1322414973249955, 1.00271509118928), (1.1668664766913612, 0.9680901118229143), (1.234915863699589, 0.97715480326406), (1.2872985139152127, 0.9861570248283982), (1.330137028703818, 0.9946545541083929), (1.3664973898197605, 1.0026062595940373), (1.3785987579468053, 0.9905048914669925), (1.4084552126570853, 0.997393466221798), (1.4084552126570853, 0.997393466221798)], [(1, 1), (1.2652550666522018, 1.0652550666522016), (1.2652550666522018, 1.0652550666522016)]]"
        self.expected_all_intermediate_budgets = "[[0, 210, 330, 450, 630, 690, 810, 930, 990, 1000], [0, 210, 270, 330, 390, 450, 1000], [0, 210, 270, 330, 390, 510, 630, 810, 1000], [0, 450, 570, 630, 1000], [0, 210, 270, 390, 570, 630, 690, 750, 810, 930, 1000], [0, 210, 270, 330, 390, 450, 510, 570, 1000], [0, 210, 270, 390, 450, 690, 750, 930, 1000], [0, 210, 570, 690, 810, 870, 1000], [0, 210, 270, 330, 390, 570, 630, 690, 810, 1000], [0, 210, 270, 330, 450, 510, 570, 630, 870, 930, 1000], [0, 210, 270, 330, 510, 570, 630, 750, 810, 990, 1000], [0, 210, 270, 330, 390, 510, 750, 810, 930, 1000], [0, 210, 270, 330, 390, 510, 630, 750, 870, 930, 1000], [0, 210, 270, 330, 390, 1000], [0, 210, 270, 330, 510, 570, 750, 870, 990, 1000], [0, 210, 270, 450, 510, 570, 630, 690, 750, 810, 870, 990, 1000], [0, 210, 270, 330, 390, 450, 510, 570, 1000], [0, 510, 750, 870, 930, 1000], [0, 270, 330, 390, 450, 510, 570, 630, 690, 750, 810, 1000], [0, 210, 330, 570, 690, 750, 990, 1000], [0, 210, 270, 330, 510, 630, 690, 810, 990, 1000], [0, 270, 450, 570, 630, 690, 750, 810, 930, 990, 1000], [0, 270, 330, 450, 570, 690, 810, 870, 990, 1000], [0, 330, 1000]]"
        self.expected_all_est_objectives = "[[-9.16944227603262, -8.76199918901914, -8.478958825757433, -8.31419158516531, -8.11131104639232, -8.109237540666536, -8.04531697247482, -7.994271738823127, -7.9992309411239555, -7.9992309411239555], [-8.940090362495347, -8.316515494500386, -7.887602329950944, -7.572060863540566, -7.5632514571935925, -7.5581831664713715, -7.5581831664713715], [-9.121210005202611, -8.707614720876107, -8.387872565278455, -8.133927458999755, -7.9256054984010635, -7.765947418936601, -7.651152490997057, -7.5616229304636775, -7.5616229304636775], [-8.779886386724968, -7.775671702387292, -7.651509542951069, -7.653423420098762, -7.653423420098762], [-8.99288952739613, -8.571080297750942, -8.245730297536934, -7.999604906463446, -7.720310120440221, -7.70966613327603, -7.702438140547024, -7.697976418780367, -7.695795051399041, -7.634617738570967, -7.634617738570967], [-8.87740808504234, -8.444311106025948, -8.107250933956582, -7.840039244548475, -7.621634345310226, -7.4386824804625915, -7.282477738705977, -7.274670186423022, -7.274670186423022], [-9.024638576352391, -8.882127270935003, -8.845624561056535, -8.718851005159365, -8.753880278277734, -8.57855425668448, -8.621371031845321, -8.571915464036836, -8.571915464036836], [-8.921050660074993, -8.391427379336571, -7.473382441260676, -7.385771299561927, -7.321958598189855, -7.331719815012605, -7.331719815012605], [-8.550164686658025, -8.030700364956498, -7.577743523325219, -7.219540952575464, -7.172468400719894, -7.198964317519387, -7.272797028412522, -7.377116995134969, -7.572568527460646, -7.572568527460646], [-8.983830735669818, -8.44483638080425, -8.375791123184792, -8.341465697321043, -8.183989286094437, -8.184903347817244, -8.192075277340896, -8.204005319994922, -8.037564480249985, -8.053025925953289, -8.053025925953289], [-9.025843710458552, -8.56858336070514, -8.228106464259831, -8.186310711696567, -7.869884605150717, -7.86423158486881, -7.862442846640894, -7.783406298919158, -7.787593925763075, -7.675803941589404, -7.675803941589404], [-9.203733926294058, -8.8970120848325, -8.637563727329233, -8.420808109729833, -8.23638347567521, -8.07821023047627, -7.797313777241498, -7.790119010460919, -7.7250558962918445, -7.7250558962918445], [-9.33623207280299, -8.766458532793413, -8.702315117944437, -8.661310042417206, -8.63406196656604, -8.465469102621194, -8.341263267732957, -8.244057650877586, -8.164878865362397, -8.165691433395237, -8.165691433395237], [-9.573886675373538, -9.01256139045244, -8.589697258759381, -8.265142743717071, -8.007563878742829, -8.007563878742829], [-8.941889405024408, -8.413779484214439, -8.332250969734114, -8.322082924261387, -8.172062113243207, -8.21641037671657, -8.178053034490583, -8.196263416833723, -8.222487314340617, -8.222487314340617], [-9.587195496910567, -9.392468519445993, -9.334760684272467, -9.260503524724822, -9.291680149160966, -9.338109614547081, -9.396652587749003, -9.465262030521922, -9.483283782469265, -9.49625537033827, -9.565540691689144, -9.654838769616823, -9.654838769616823], [-9.346621843523279, -8.791224299276783, -8.667493193150776, -8.926236847711316, -9.437155585946881, -9.881627344431315, -10.86636898235284, -11.304519773452867, -11.304519773452867], [-9.398264139884379, -8.816557105501339, -8.623547051169965, -8.568097539270452, -8.560648406297657, -8.560648406297657], [-8.499265659696825, -8.356245151485414, -8.442011596812325, -8.617674940588268, -8.860873835724695, -9.010180288129408, -9.314692695464343, -9.482591346302335, -9.885427760296556, -10.099274368057488, -10.704611858895083, -10.704611858895083], [-9.254478807791063, -9.115427923335954, -8.845335548555322, -8.458035941963214, -8.376607781187609, -8.385523786862707, -8.219069297394633, -8.219069297394633], [-9.605611629911163, -9.028247089841932, -8.960139410177089, -8.91884003893432, -8.553520196341015, -8.425746247851105, -8.423912350764207, -8.335624200857545, -8.193661390560013, -8.193661390560013], [-8.501695309087717, -8.103319408941141, -7.768607094569495, -7.669278415446506, -7.682801002129309, -7.699736944809498, -7.719393101667748, -7.741259480369391, -7.711111979937577, -7.734902023167122, -7.734902023167122], [-9.152042163756049, -8.70017273489177, -8.672103663085403, -8.468284351054752, -8.321346911621498, -8.207626176164167, -8.115597015035902, -8.117409217473796, -8.046429474131209, -8.046429474131209], [-9.213076761398039, -8.244033521722185, -8.244033521722185]]"
        self.expected_objective_curves = "[([0, 210, 330, 450, 630, 690, 810, 930, 990, 1000], [-9.265122221743944, -8.76199918901914, -8.478958825757433, -8.31419158516531, -8.11131104639232, -8.109237540666536, -8.04531697247482, -7.994271738823127, -7.9992309411239555, -7.9992309411239555]), ([0, 210, 270, 330, 390, 450, 1000], [-9.265122221743944, -8.316515494500386, -7.887602329950944, -7.572060863540566, -7.5632514571935925, -7.5581831664713715, -7.5581831664713715]), ([0, 210, 270, 330, 390, 510, 630, 810, 1000], [-9.265122221743944, -8.707614720876107, -8.387872565278455, -8.133927458999755, -7.9256054984010635, -7.765947418936601, -7.651152490997057, -7.5616229304636775, -7.5616229304636775]), ([0, 450, 570, 630, 1000], [-9.265122221743944, -7.775671702387292, -7.651509542951069, -7.653423420098762, -7.653423420098762]), ([0, 210, 270, 390, 570, 630, 690, 750, 810, 930, 1000], [-9.265122221743944, -8.571080297750942, -8.245730297536934, -7.999604906463446, -7.720310120440221, -7.70966613327603, -7.702438140547024, -7.697976418780367, -7.695795051399041, -7.634617738570967, -7.634617738570967]), ([0, 210, 270, 330, 390, 450, 510, 570, 1000], [-9.265122221743944, -8.444311106025948, -8.107250933956582, -7.840039244548475, -7.621634345310226, -7.4386824804625915, -7.282477738705977, -7.274670186423022, -7.274670186423022]), ([0, 210, 270, 390, 450, 690, 750, 930, 1000], [-9.265122221743944, -8.882127270935003, -8.845624561056535, -8.718851005159365, -8.753880278277734, -8.57855425668448, -8.621371031845321, -8.571915464036836, -8.571915464036836]), ([0, 210, 570, 690, 810, 870, 1000], [-9.265122221743944, -8.391427379336571, -7.473382441260676, -7.385771299561927, -7.321958598189855, -7.331719815012605, -7.331719815012605]), ([0, 210, 270, 330, 390, 570, 630, 690, 810, 1000], [-9.265122221743944, -8.030700364956498, -7.577743523325219, -7.219540952575464, -7.172468400719894, -7.198964317519387, -7.272797028412522, -7.377116995134969, -7.572568527460646, -7.572568527460646]), ([0, 210, 270, 330, 450, 510, 570, 630, 870, 930, 1000], [-9.265122221743944, -8.44483638080425, -8.375791123184792, -8.341465697321043, -8.183989286094437, -8.184903347817244, -8.192075277340896, -8.204005319994922, -8.037564480249985, -8.053025925953289, -8.053025925953289]), ([0, 210, 270, 330, 510, 570, 630, 750, 810, 990, 1000], [-9.265122221743944, -8.56858336070514, -8.228106464259831, -8.186310711696567, -7.869884605150717, -7.86423158486881, -7.862442846640894, -7.783406298919158, -7.787593925763075, -7.675803941589404, -7.675803941589404]), ([0, 210, 270, 330, 390, 510, 750, 810, 930, 1000], [-9.265122221743944, -8.8970120848325, -8.637563727329233, -8.420808109729833, -8.23638347567521, -8.07821023047627, -7.797313777241498, -7.790119010460919, -7.7250558962918445, -7.7250558962918445]), ([0, 210, 270, 330, 390, 510, 630, 750, 870, 930, 1000], [-9.265122221743944, -8.766458532793413, -8.702315117944437, -8.661310042417206, -8.63406196656604, -8.465469102621194, -8.341263267732957, -8.244057650877586, -8.164878865362397, -8.165691433395237, -8.165691433395237]), ([0, 210, 270, 330, 390, 1000], [-9.265122221743944, -9.01256139045244, -8.589697258759381, -8.265142743717071, -8.007563878742829, -8.007563878742829]), ([0, 210, 270, 330, 510, 570, 750, 870, 990, 1000], [-9.265122221743944, -8.413779484214439, -8.332250969734114, -8.322082924261387, -8.172062113243207, -8.21641037671657, -8.178053034490583, -8.196263416833723, -8.222487314340617, -8.222487314340617]), ([0, 210, 270, 450, 510, 570, 630, 690, 750, 810, 870, 990, 1000], [-9.265122221743944, -9.392468519445993, -9.334760684272467, -9.260503524724822, -9.291680149160966, -9.338109614547081, -9.396652587749003, -9.465262030521922, -9.483283782469265, -9.49625537033827, -9.565540691689144, -9.654838769616823, -9.654838769616823]), ([0, 210, 270, 330, 390, 450, 510, 570, 1000], [-9.265122221743944, -8.791224299276783, -8.667493193150776, -8.926236847711316, -9.437155585946881, -9.881627344431315, -10.86636898235284, -11.304519773452867, -11.304519773452867]), ([0, 510, 750, 870, 930, 1000], [-9.265122221743944, -8.816557105501339, -8.623547051169965, -8.568097539270452, -8.560648406297657, -8.560648406297657]), ([0, 270, 330, 390, 450, 510, 570, 630, 690, 750, 810, 1000], [-9.265122221743944, -8.356245151485414, -8.442011596812325, -8.617674940588268, -8.860873835724695, -9.010180288129408, -9.314692695464343, -9.482591346302335, -9.885427760296556, -10.099274368057488, -10.704611858895083, -10.704611858895083]), ([0, 210, 330, 570, 690, 750, 990, 1000], [-9.265122221743944, -9.115427923335954, -8.845335548555322, -8.458035941963214, -8.376607781187609, -8.385523786862707, -8.219069297394633, -8.219069297394633]), ([0, 210, 270, 330, 510, 630, 690, 810, 990, 1000], [-9.265122221743944, -9.028247089841932, -8.960139410177089, -8.91884003893432, -8.553520196341015, -8.425746247851105, -8.423912350764207, -8.335624200857545, -8.193661390560013, -8.193661390560013]), ([0, 270, 450, 570, 630, 690, 750, 810, 930, 990, 1000], [-9.265122221743944, -8.103319408941141, -7.768607094569495, -7.669278415446506, -7.682801002129309, -7.699736944809498, -7.719393101667748, -7.741259480369391, -7.711111979937577, -7.734902023167122, -7.734902023167122]), ([0, 270, 330, 450, 570, 690, 810, 870, 990, 1000], [-9.265122221743944, -8.70017273489177, -8.672103663085403, -8.468284351054752, -8.321346911621498, -8.207626176164167, -8.115597015035902, -8.117409217473796, -8.046429474131209, -8.046429474131209]), ([0, 330, 1000], [-9.265122221743944, -8.244033521722185, -8.244033521722185])]"
        self.expected_progress_curves = "[([0.0, 0.21, 0.33, 0.45, 0.63, 0.69, 0.81, 0.93, 0.99, 1.0], [1.0, 0.8919868632623278, 0.8312222481070737, 0.795849137892697, 0.7522936614971535, 0.7518485102261562, 0.7381257016418433, 0.7271670385642127, 0.7282317065706211, 0.7282317065706211]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.45, 1.0], [1.0, 0.7963480471463962, 0.7042666808051201, 0.6365245554382775, 0.6346333050870859, 0.6335452173964058, 0.6335452173964058]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.51, 0.63, 0.81, 1.0], [1.0, 0.8803113155098719, 0.8116673637783721, 0.7571490736102752, 0.7124254037481677, 0.6781491555011473, 0.6535043679604678, 0.634283684280806, 0.634283684280806]), ([0.0, 0.45, 0.57, 0.63, 1.0], [1.0, 0.6802368165496725, 0.6535810217787641, 0.6539919031350266, 0.6539919031350266]), ([0.0, 0.21, 0.27, 0.39, 0.57, 0.63, 0.69, 0.75, 0.81, 0.93, 1.0], [1.0, 0.850999377166385, 0.7811515034357877, 0.7283119914447418, 0.6683514967930363, 0.6660663888448405, 0.6645146448057159, 0.6635567785743544, 0.6630884709877224, 0.6499545990996577, 0.6499545990996577]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.45, 0.51, 0.57, 1.0], [1.0, 0.8237838907956675, 0.7514220148994681, 0.6940555838902775, 0.6471672549703373, 0.6078901726090364, 0.5743553053240823, 0.5726791383480683, 0.5726791383480683]), ([0.0, 0.21, 0.27, 0.39, 0.45, 0.69, 0.75, 0.93, 1.0], [1.0, 0.917776600750076, 0.9099400042578716, 0.8827235809633892, 0.8902438521914114, 0.8526039265424847, 0.8617960602539295, 0.851178675120105, 0.851178675120105]), ([0.0, 0.21, 0.57, 0.69, 0.81, 0.87, 1.0], [1.0, 0.8124305302246723, 0.6153397453113171, 0.5965309180214986, 0.5828312668614772, 0.5849268569633488, 0.5849268569633488]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.57, 0.63, 0.69, 0.81, 1.0], [1.0, 0.7349877303627964, 0.6377445391568307, 0.5608437003209715, 0.5507379137648869, 0.5564261985344275, 0.5722769987934077, 0.5946729657779372, 0.6366335434369375, 0.6366335434369375]), ([0.0, 0.21, 0.27, 0.33, 0.45, 0.51, 0.57, 0.63, 0.87, 0.93, 1.0], [1.0, 0.8238966595873215, 0.8090736553373498, 0.8017044897928499, 0.7678966137219465, 0.768092849368956, 0.7696325574600681, 0.7721937626616999, 0.7364613552528422, 0.7397807009005031, 0.7397807009005031]), ([0.0, 0.21, 0.27, 0.33, 0.51, 0.57, 0.63, 0.75, 0.81, 0.99, 1.0], [1.0, 0.8504633214006752, 0.7773679248878286, 0.7683949897546064, 0.7004629451240821, 0.6992493245720998, 0.6988653087067291, 0.6818973209958367, 0.6827963430669367, 0.6587966728847577, 0.6587966728847577]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.51, 0.75, 0.81, 0.93, 1.0], [1.0, 0.9209721520054378, 0.8652723945055797, 0.8187381421664931, 0.7791448778548726, 0.7451874017493028, 0.6848830526360113, 0.6833384417207496, 0.6693703452707368, 0.6693703452707368]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.51, 0.63, 0.75, 0.87, 0.93, 1.0], [1.0, 0.8929442189735985, 0.8791735684800575, 0.8703703801110528, 0.8645206178236637, 0.8283262023789011, 0.8016610311289536, 0.780792410727685, 0.7637938866484806, 0.7639683330886773, 0.7639683330886773]), ([0.0, 0.21, 0.27, 0.33, 0.39, 1.0], [1.0, 0.9457788933710162, 0.8549961656738678, 0.7853190709437032, 0.7300206660733878, 0.7300206660733878]), ([0.0, 0.21, 0.27, 0.33, 0.51, 0.57, 0.75, 0.87, 0.99, 1.0], [1.0, 0.8172291993443754, 0.7997262229155475, 0.7975432926687401, 0.7653360246248887, 0.774856946417485, 0.7666221875587796, 0.770531689589371, 0.7761615758060016, 0.7761615758060016]), ([0.0, 0.21, 0.27, 0.45, 0.51, 0.57, 0.63, 0.69, 0.75, 0.81, 0.87, 0.99, 1.0], [1.0, 1.0273393825606298, 1.0149503566444928, 0.9990084334840039, 1.0057015975397274, 1.015669322861797, 1.0282376406651836, 1.0429670818589052, 1.0468360877098168, 1.04962089739466, 1.064495439807189, 1.0836664275661407, 1.0836664275661407]), ([0.0, 0.21, 0.27, 0.33, 0.39, 0.45, 0.51, 0.57, 1.0], [1.0, 0.8982610658432282, 0.87169781189655, 0.9272462800091982, 1.0369330403946293, 1.1323546086842138, 1.343764196935515, 1.4378287462257728, 1.4378287462257728]), ([0.0, 0.51, 0.75, 0.87, 0.93, 1.0], [1.0, 0.9036996478295524, 0.8622632196912219, 0.8503590226633049, 0.8487598030568997, 0.8487598030568997]), ([0.0, 0.27, 0.33, 0.39, 0.45, 0.51, 0.57, 0.63, 0.69, 0.75, 0.81, 1.0], [1.0, 0.8048774218586285, 0.8232902198902122, 0.8610025636648728, 0.9132137998958128, 0.9452677056215484, 1.010642053747997, 1.046687431819476, 1.1331705022367096, 1.1790802328246213, 1.3090373147259862, 1.3090373147259862]), ([0.0, 0.21, 0.33, 0.57, 0.69, 0.75, 0.99, 1.0], [1.0, 0.9678628294251912, 0.9098779575122806, 0.8267304117942497, 0.8092489798341204, 0.8111631154977624, 0.7754277776935224, 0.7754277776935224]), ([0.0, 0.21, 0.27, 0.33, 0.51, 0.63, 0.69, 0.81, 0.99, 1.0], [1.0, 0.9491463829963815, 0.9345246629835192, 0.9256582936402874, 0.8472294809156695, 0.8197982880024604, 0.8194045771923287, 0.8004504061687167, 0.7699730727075814, 0.7699730727075814]), ([0.0, 0.27, 0.45, 0.57, 0.63, 0.69, 0.75, 0.81, 0.93, 0.99, 1.0], [1.0, 0.7505779741351634, 0.6787201488549157, 0.6573957381198736, 0.6602988391695437, 0.6639347376943827, 0.668154626310829, 0.672849017143757, 0.6663767909194774, 0.6714841643156653, 0.6714841643156653]), ([0.0, 0.27, 0.33, 0.45, 0.57, 0.69, 0.81, 0.87, 0.99, 1.0], [1.0, 0.8787136302570768, 0.8726876121781568, 0.8289305949314694, 0.7973852815487116, 0.7729711073807402, 0.7532137961104417, 0.7536028493975878, 0.7383645394324362, 0.7383645394324362]), ([0.0, 0.33, 1.0], [1.0, 0.7807872305518788, 0.7807872305518788])]"

        # Convert the expected values from string to their actual types
        self.expected_all_recommended_xs = eval(self.expected_all_recommended_xs, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_all_intermediate_budgets = eval(self.expected_all_intermediate_budgets, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_all_est_objectives = eval(self.expected_all_est_objectives, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_objective_curves = eval(self.expected_objective_curves, {'nan': float('nan'), 'inf': float('inf')})
        self.expected_progress_curves = eval(self.expected_progress_curves, {'nan': float('nan'), 'inf': float('inf')})
        
        # Number of macro-replications and post-replications
        self.num_macroreps = 24
        self.num_postreps = 200

        # Setup the solver and experiment
        self.myexperiment = ProblemSolver(self.expected_solver_name, self.expected_problem_name)
        self.assertEqual(self.myexperiment.solver.name, self.expected_solver_name, "Solver name does not match (expected: " + self.expected_solver_name + ", actual: " + self.myexperiment.solver.name + ")")
        self.assertEqual(self.myexperiment.problem.name, self.expected_problem_name, "Problem name does not match (expected: " + self.expected_problem_name + ", actual: " + self.myexperiment.problem.name + ")")

    def test_run(self):
        # Check actual run results against expected
        self.myexperiment.run(n_macroreps=self.num_macroreps)
        self.assertEqual(self.myexperiment.n_macroreps, self.num_macroreps, "Number of macro-replications for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
        # For each macroreplication
        for mrep in range(self.num_macroreps):
            # Check to make sure the list lengths are the same
            self.assertEqual(len(self.myexperiment.all_recommended_xs[mrep]), len(self.expected_all_recommended_xs[mrep]), "Length of recommended solutions for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
            # For each list of recommended solutions
            for list in range(len(self.myexperiment.all_recommended_xs[mrep])):
                # Check to make sure the tuples are the same length
                self.assertEqual(len(self.myexperiment.all_recommended_xs[mrep][list]), len(self.expected_all_recommended_xs[mrep][list]), "Recommended solutions for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + ".")
                # For each tuple of recommended solutions
                for tuple in range(len(self.myexperiment.all_recommended_xs[mrep][list])):
                    self.assertAlmostEqual(self.myexperiment.all_recommended_xs[mrep][list][tuple], self.expected_all_recommended_xs[mrep][list][tuple], 5, "Recommended solutions for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + " and tuple " + str(tuple) + ".")
            # Check to make sure the list lengths are the same
            self.assertEqual(len(self.myexperiment.all_intermediate_budgets[mrep]), len(self.expected_all_intermediate_budgets[mrep]), "Length of intermediate budgets for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
            # For each list of intermediate budgets
            for list in range(len(self.myexperiment.all_intermediate_budgets[mrep])):
                # Check the values in the list
                self.assertAlmostEqual(self.myexperiment.all_intermediate_budgets[mrep][list], self.expected_all_intermediate_budgets[mrep][list], 5, "Intermediate budgets for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + ".")
            
    def test_post_replicate(self):
        # Simulate results from the run method
        self.myexperiment = ProblemSolver(self.expected_solver_name, self.expected_problem_name)
        self.myexperiment.n_macroreps = self.num_macroreps
        self.myexperiment.all_recommended_xs = self.expected_all_recommended_xs
        self.myexperiment.all_intermediate_budgets = self.expected_all_intermediate_budgets

        # Check actual post-replication results against expected
        self.myexperiment.post_replicate(n_postreps=self.num_postreps)
        self.assertEqual(self.myexperiment.n_postreps, self.num_postreps, "Number of post-replications for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
        # For each macroreplication
        for mrep in range(self.num_macroreps):
            # Check to make sure the list lengths are the same
            self.assertEqual(len(self.myexperiment.all_est_objectives[mrep]), len(self.expected_all_est_objectives[mrep]), "Estimated objectives for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
            # For each list in the estimated objectives
            for list in range(len(self.myexperiment.all_est_objectives[mrep])):
                # Check the values in the list
                self.assertAlmostEqual(self.myexperiment.all_est_objectives[mrep][list], self.expected_all_est_objectives[mrep][list], 5, "Estimated objectives for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(list) + ".")

    def test_post_normalize(self):
        # Simulate results from the post_replicate method
        self.myexperiment = ProblemSolver(self.expected_solver_name, self.expected_problem_name)
        self.myexperiment.n_macroreps = self.num_macroreps
        self.myexperiment.n_postreps = self.num_postreps
        self.myexperiment.all_recommended_xs = self.expected_all_recommended_xs
        self.myexperiment.all_intermediate_budgets = self.expected_all_intermediate_budgets
        self.myexperiment.all_est_objectives = self.expected_all_est_objectives

        # Check actual post-normalization results against expected
        post_normalize([self.myexperiment], n_postreps_init_opt=self.num_postreps)

        # Loop through each curve object and convert it into a tuple
        for i in range(len(self.myexperiment.objective_curves)):
            self.myexperiment.objective_curves[i] = (self.myexperiment.objective_curves[i].x_vals, self.myexperiment.objective_curves[i].y_vals)
        for i in range(len(self.myexperiment.progress_curves)):
            self.myexperiment.progress_curves[i] = (self.myexperiment.progress_curves[i].x_vals, self.myexperiment.progress_curves[i].y_vals)

        for mrep in range(self.num_macroreps):
            # Check to make sure the same number of objective curves are present
            # This should probably always be 2 (x and y)
            self.assertEqual(len(self.myexperiment.objective_curves[mrep]), len(self.expected_objective_curves[mrep]), "Number of objective curves for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
            # Make sure that curves are only checked if they exist
            if (len(self.myexperiment.objective_curves[mrep]) > 0):
                # Make sure the lengths of the X and Y values are the same
                self.assertEqual(len(self.myexperiment.objective_curves[mrep][0]), len(self.expected_objective_curves[mrep][0]), "Length of X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                self.assertEqual(len(self.myexperiment.objective_curves[mrep][1]), len(self.expected_objective_curves[mrep][1]), "Length of Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                # Check X (0) and Y (1) values
                for x_index in range(len(self.myexperiment.objective_curves[mrep][0])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.objective_curves[mrep][0][x_index])):
                        self.assertTrue(math.isnan(self.expected_objective_curves[mrep][0][x_index]), "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.objective_curves[mrep][0][x_index], self.expected_objective_curves[mrep][0][x_index], 5, "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                for y_index in range(len(self.myexperiment.objective_curves[mrep][1])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.objective_curves[mrep][1][y_index])):
                        self.assertTrue(math.isnan(self.expected_objective_curves[mrep][1][y_index]), "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.objective_curves[mrep][1][y_index], self.expected_objective_curves[mrep][1][y_index], 5, "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")
            
            # Check to make sure the same number of progress curves are present
            # This should probably always be 2 (x and y)
            self.assertEqual(len(self.myexperiment.progress_curves[mrep]), len(self.expected_progress_curves[mrep]), "Number of progress curves for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " does not match.")
            # Make sure that curves are only checked if they exist
            if (len(self.myexperiment.progress_curves[mrep]) > 0):
                # Make sure the lengths of the X and Y values are the same
                self.assertEqual(len(self.myexperiment.progress_curves[mrep][0]), len(self.expected_progress_curves[mrep][0]), "Length of X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                self.assertEqual(len(self.myexperiment.progress_curves[mrep][1]), len(self.expected_progress_curves[mrep][1]), "Length of Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match.")
                # Check X (0) and Y (1) values
                for x_index in range(len(self.myexperiment.progress_curves[mrep][0])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.progress_curves[mrep][0][x_index])):
                        self.assertTrue(math.isnan(self.expected_progress_curves[mrep][0][x_index]), "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.progress_curves[mrep][0][x_index], self.expected_progress_curves[mrep][0][x_index], 5, "X values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(x_index) + ".")
                for y_index in range(len(self.myexperiment.progress_curves[mrep][1])):
                    # If the value is NaN, make sure we're expecting NaN
                    if (math.isnan(self.myexperiment.progress_curves[mrep][1][y_index])):
                        self.assertTrue(math.isnan(self.expected_progress_curves[mrep][1][y_index]), "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")
                    # Otherwise, check the value normally
                    else:
                        self.assertAlmostEqual(self.myexperiment.progress_curves[mrep][1][y_index], self.expected_progress_curves[mrep][1][y_index], 5, "Y values for problem " + self.expected_problem_name + " and solver " + self.expected_solver_name + " do not match at mrep " + str(mrep) + " and index " + str(y_index) + ".")      
